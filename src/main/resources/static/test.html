<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input[type="text"] { width: 90%; max-width: 500px; margin-bottom: 5px; }
        .container { display: flex; gap: 20px; }
        .log-box { width: 50%; height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; background-color: #f9f9f9; }
        .log-box div { border-bottom: 1px solid #eee; padding: 4px 2px; font-size: 14px; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    </style>
</head>
<body>
<h2>WebSocket 테스트 페이지</h2>

<div>
    <label for="jwtToken">JWT 토큰:</label><br>
    <input type="text" id="jwtToken" placeholder="로그인 API에서 받은 JWT를 여기에 붙여넣으세요.">
</div>
<div>
    <label for="roomId">Room ID:</label><br>
    <input type="text" id="roomId" value="2">
</div>
<p>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()" disabled>Disconnect</button>
</p>
<div id="status">연결 상태: Disconnected</div>
<hr>
<div>
    <input type="text" id="messageInput" placeholder="메시지 입력">
    <button onclick="sendMessage()">Send</button>
</div>
<br>

<div class="container">
    <div>
        <h3>채팅 메시지</h3>
        <div id="messages" class="log-box"></div>
    </div>
    <div>
        <h3>프로토콜 로그 (디버깅용)</h3>
        <div id="protocol-log" class="log-box"></div>
    </div>
</div>

<script>
    let stompClient = null;

    function setConnected(connected) {
        document.querySelector("button[onclick='connect()']").disabled = connected;
        document.querySelector("button[onclick='disconnect()']").disabled = !connected;
        document.getElementById('status').innerText = connected ? '연결 상태: Connected' : '연결 상태: Disconnected';
        if (!connected) document.getElementById('messages').innerHTML = '';
    }

    function logProtocol(message) {
        const logDiv = document.getElementById('protocol-log');
        const p = document.createElement('pre');
        p.textContent = message;
        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function connect() {
        const jwtToken = document.getElementById('jwtToken').value;
        const roomId = document.getElementById('roomId').value;

        if (!jwtToken || !roomId) {
            alert("JWT 토큰과 Room ID를 입력해주세요.");
            return;
        }

        // ★ 쿼리 파라미터로 JWT 전달 ★
        const socket = new SockJS('/ws-stomp?token=' + jwtToken);
        stompClient = Stomp.over(socket);
        stompClient.debug = function (str) { logProtocol(str); };

        stompClient.connect({}, function(frame) {  // 헤더 없이 CONNECT
            setConnected(true);
            console.log('Connected: ' + frame);

            // 구독
            stompClient.subscribe('/sub/chat/room/' + roomId, function(message) {
                showMessage(JSON.parse(message.body));
            });

        }, function(error) {
            console.error('STOMP error: ' + error);
            setConnected(false);
            logProtocol("CONNECTION ERROR:\n" + error);
        });
    }

    function disconnect() {
        if (stompClient !== null) stompClient.disconnect();
        setConnected(false);
        console.log("Disconnected");
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value;
        const roomId = document.getElementById('roomId').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (messageContent && stompClient) {
            const chatMessage = {
                roomId: roomId,
                message: messageContent,
                amount: 0
            };

            const headers = { 'Authorization': 'Bearer ' + jwtToken };

            stompClient.send("/pub/chat/message", headers, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const p = document.createElement('div');
        p.textContent = message.senderNickname + ": " + message.message;
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
